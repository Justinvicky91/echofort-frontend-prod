{
  "query": "-- Promo Code System Migration\nCREATE TABLE IF NOT EXISTS promo_codes (\n    id SERIAL PRIMARY KEY,\n    code VARCHAR(50) UNIQUE NOT NULL,\n    discount_percentage DECIMAL(5,2) NOT NULL DEFAULT 10.00,\n    created_by_user_id INTEGER,\n    created_by_name VARCHAR(255),\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    expires_at TIMESTAMP,\n    max_uses INTEGER DEFAULT NULL,\n    current_uses INTEGER DEFAULT 0,\n    is_active BOOLEAN DEFAULT TRUE,\n    applicable_plans TEXT[] DEFAULT ARRAY['Personal', 'Family'],\n    notes TEXT,\n    CONSTRAINT valid_discount CHECK (discount_percentage >= 0 AND discount_percentage <= 100)\n);\n\nCREATE TABLE IF NOT EXISTS promo_code_usage (\n    id SERIAL PRIMARY KEY,\n    promo_code_id INTEGER REFERENCES promo_codes(id) ON DELETE CASCADE,\n    user_id INTEGER,\n    subscription_id INTEGER,\n    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    original_amount DECIMAL(10,2) NOT NULL,\n    discount_amount DECIMAL(10,2) NOT NULL,\n    final_amount DECIMAL(10,2) NOT NULL,\n    commission_amount DECIMAL(10,2) NOT NULL,\n    commission_paid BOOLEAN DEFAULT FALSE,\n    commission_paid_at TIMESTAMP,\n    CONSTRAINT valid_amounts CHECK (\n        original_amount >= final_amount AND\n        final_amount >= 0 AND\n        discount_amount >= 0 AND\n        commission_amount >= 0\n    )\n);\n\nCREATE INDEX IF NOT EXISTS idx_promo_codes_code ON promo_codes(code);\nCREATE INDEX IF NOT EXISTS idx_promo_codes_active ON promo_codes(is_active);\nCREATE INDEX IF NOT EXISTS idx_promo_code_usage_promo ON promo_code_usage(promo_code_id);\n\nINSERT INTO promo_codes (code, discount_percentage, created_by_name, notes, max_uses)\nVALUES \n    ('WELCOME10', 10.00, 'System', 'Welcome offer for new users', NULL),\n    ('FAMILY2025', 10.00, 'System', 'Family plan promotion 2025', 1000)\nON CONFLICT (code) DO NOTHING;",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 2y6sS8DpnU5zjJD.root --database 9Rouc7DxCXtQDEEF5GnzG8 --execute -- Promo Code System Migration\nCREATE TABLE IF NOT EXISTS promo_codes (\n    id SERIAL PRIMARY KEY,\n    code VARCHAR(50) UNIQUE NOT NULL,\n    discount_percentage DECIMAL(5,2) NOT NULL DEFAULT 10.00,\n    created_by_user_id INTEGER,\n    created_by_name VARCHAR(255),\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    expires_at TIMESTAMP,\n    max_uses INTEGER DEFAULT NULL,\n    current_uses INTEGER DEFAULT 0,\n    is_active BOOLEAN DEFAULT TRUE,\n    applicable_plans TEXT[] DEFAULT ARRAY['Personal', 'Family'],\n    notes TEXT,\n    CONSTRAINT valid_discount CHECK (discount_percentage >= 0 AND discount_percentage <= 100)\n);\n\nCREATE TABLE IF NOT EXISTS promo_code_usage (\n    id SERIAL PRIMARY KEY,\n    promo_code_id INTEGER REFERENCES promo_codes(id) ON DELETE CASCADE,\n    user_id INTEGER,\n    subscription_id INTEGER,\n    used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    original_amount DECIMAL(10,2) NOT NULL,\n    discount_amount DECIMAL(10,2) NOT NULL,\n    final_amount DECIMAL(10,2) NOT NULL,\n    commission_amount DECIMAL(10,2) NOT NULL,\n    commission_paid BOOLEAN DEFAULT FALSE,\n    commission_paid_at TIMESTAMP,\n    CONSTRAINT valid_amounts CHECK (\n        original_amount >= final_amount AND\n        final_amount >= 0 AND\n        discount_amount >= 0 AND\n        commission_amount >= 0\n    )\n);\n\nCREATE INDEX IF NOT EXISTS idx_promo_codes_code ON promo_codes(code);\nCREATE INDEX IF NOT EXISTS idx_promo_codes_active ON promo_codes(is_active);\nCREATE INDEX IF NOT EXISTS idx_promo_code_usage_promo ON promo_code_usage(promo_code_id);\n\nINSERT INTO promo_codes (code, discount_percentage, created_by_name, notes, max_uses)\nVALUES \n    ('WELCOME10', 10.00, 'System', 'Welcome offer for new users', NULL),\n    ('FAMILY2025', 10.00, 'System', 'Family plan promotion 2025', 1000)\nON CONFLICT (code) DO NOTHING;",
  "returncode": 1,
  "logs": [
    "ERROR 1064 (42000) at line 2: You have an error in your SQL syntax; check the manual that corresponds to your TiDB version for the right syntax to use line 12 column 27 near \"[] DEFAULT ARRAY['Personal', 'Family'],",
    "    notes TEXT,",
    "    CONSTRAINT valid_discount CHECK (discount_percentage >= 0 AND discount_percentage <= 100)",
    ")\""
  ]
}